<html>
  <head>
    <title>statistic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css" />
    <!-- TODO remove this after the data is properly handled -->
    <script type="text/javascript" src="data.js"></script>
  </head>
  <body>
    <div id="liveAlertPlaceholder"></div>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_statistic">
      ADD Statistic
    </button>
    <div id="totalStat" class="table"></div>
    <div id="monthsStat" class="table"></div>
    <div class="modal fade" id="modal_statistic" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add statistic</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body ">
            <div class="input-group mb-3 statistic" id="modalWindow">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="add-stat-button">Add Statistic</button>
          </div>
        </div>
      </div>
    </div>
    <div>
      <canvas id="myChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.8/ejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript">

    const ctx = document.getElementById('myChart');
    const Table = function(data, parentElementId) {
      this.data = data;
      this.parentElementId = parentElementId;

      const nameRemder = () => {
        const name = document.querySelector(`#${this.parentElementId}`);
        name.innerHTML =
        `<table class="table table-striped">
            <thead>
              <tr>
                ${Object.keys(data[0]).map((key) => `<th scope="col"><button id="${key}">${key}&uarr;</button></th>`).join("")}
              </tr>
            </thead>
            <tbody>
            </tbody>
        </table>`
        }

        const buttonGroup = document.getElementById(parentElementId);
        let audit = false;
        // TODO: use the column name to detect order of sorting
        let columnName = null;

        const dateComparator = (a, b) => {
          const dateA = new Date (`${a.split(".")[1]}-${a.split(".")[0]}`);
          const dateB = new Date (`${b.split(".")[1]}-${b.split(".")[0]}`);
          return dateB - dateA
        }

        const intComparator = (a, b) => a - b

        const sortTable = e => {
          const column = e.target.id;
          audit = (column === columnName) ? audit : false;
          columnName = column;
          const orderCoef = audit ? -1 : 1;
          const comparator = (e.target.id === "Month") ? dateComparator : intComparator
          data.sort((a, b) => comparator(a[column], b[column]) * orderCoef)
          if (column) {
            e.target.innerHTML = (audit === true) ? `${column}&darr;` : `${column}&uarr;`
          }
          // TODO: use the column name to detect order of sorting
          audit = !audit
          valueRender(data, parentElementId);
        }

        buttonGroup.addEventListener('click', sortTable);

      const valueRender = data => {
        var tableBody = document.querySelector(`#${this.parentElementId} > table tbody`);
        tableBody.innerHTML = this.data.map(column => `<tr>${Object.values(column).map(row => `<td>${row}</td>`).join("")}</tr>`).join("");
      }

      this.updateData = data => {
        this.data = data
        nameRemder();
        valueRender();
      }

      nameRemder();
      valueRender();
    }

      const RenderModalWindow = function() {
        const modal = () => {
          var tableBody = document.querySelector("#modalWindow");
          tableBody.innerHTML = `${Object.keys(staticByDay[0]).map(row => `<div>
            <span class="input-group-text">${row}</span>
              <${(row === "Date") ? `input type="date"` : `input type="number"`} class="form-control" id="input-${row}">
              <div id="${row}-input"></div>
            </div>`).join("")}`;
        }



        const showError = (message, type, id) => {
          const alertPlaceholder = document.getElementById(id)
          const wrapper = document.createElement('div')
          wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
          ].join('')
          alertPlaceholder.append(wrapper)
        }

         const addStatByDay = () => {
          const startSTat = Object.keys(staticByDay[0]).reduce((accum, field) => {
              const value = document.getElementById(`input-${field}`).value
              if (value) {
                accum[field] = field === "Date" ? value : Number(value)
              }
              return accum
            }, {})
            try {
              dataModule.addStatByDay(startSTat)
              monthsStatsTable.updateData(dataModule.calculateMonthsStat())
              totalStatsTable.updateData(dataModule.calculateTotalStat())
              Object.keys(startSTat).forEach(field => {
              document.getElementById(`input-${field}`).value = '';
              myChart.data = dataModule.createDataForGraph();
              myChart.update();
            })
            }
            catch (errors) {
              const showModal = new bootstrap.Modal('#modal_statistic', {keyboard: false});
              showModal.show();
              errors.forEach(element => {
                showError(element.message, "danger", element.field);
              });
            }
            //

         }

        const addButton = document.querySelector("#add-stat-button")
        addButton.addEventListener("click", addStatByDay)
        modal();
      }

      const monthsStatsTable = new Table(dataModule.calculateMonthsStat(), "monthsStat");
      const totalStatsTable = new Table(dataModule.calculateTotalStat(), "totalStat");

      const newData = new RenderModalWindow();
      const myChart = new Chart(ctx, {
              type: 'line',
              data: dataModule.createDataForGraph(),
              options: {
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });


      // const useFullFunc = () => {
      //   console.log("timeout func")
      // }

      // const getData = () => {
      //   return new Promise((resolve, reject) => {
      //     setTimeout(() => {
      //       if(Math.random() > 0.5) {
      //         reject("REJECT")
      //         return
      //       }
      //       resolve("test data")
      //     }, 2*1000)
      //   })
      // }

      // const prom = getData()
      // console.log(prom)
      // prom.then(data => console.log("THEN", data)).catch(error => console.log("ERROR", error)).finally(() => console.log("FINALLY"))
      // console.log("HERE")
      // console.log(prom)
    </script>
  </body>
</html>