<html>
  <head>
    <title>statistic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css" />
    <!-- TODO remove this after the data is properly handled -->
    <script type="text/javascript" src="data.js"></script>
  </head>
  <body>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_statistic">
      ADD Statistic
    </button>
    <div id="totalStat" class="table"></div>
    <div id="monthsStat" class="table"></div>
    <div class="modal fade" id="modal_statistic" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add statistic</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body ">
            <div class="input-group mb-3 statistic" id="modalWindow">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="show.addStatByDay()">Add Statistic</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.8/ejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript">

     var i = 0;

    const RenderTable = function(data, parentElementId) {
      const keys = Object.keys(data[0]);
      const value = data.map(column => Object.values(column));
      var tableBody = document.querySelector(`#${parentElementId}`);
      const name =
      `<table class="table table-striped">
          <thead>
            <tr>
              ${keys.map((key) => `<th scope="col"><button class="buttonTable"  onclick="show.sortTable('${key}${parentElementId}','${key}')">${key}<div class="buttonTableDiv" id="${key}${parentElementId}">â–²<div></button></th>`).join("")}
            </tr>
          </thead>`
      this.tableBody = tableBody.innerHTML =
          `${name}<tbody>
            ${value.map(column => `<tr>${column.map(row => `<td>${row}</td>`).join("")}</tr>`).join("")}
          </tbody>
       </table>`
     }

     const renderBody = () => {
      const newData = new UpDate(upDate.data);
      const newTotalStatsTable = new RenderTable(newData.calculateTotalStat, "totalStat");
      const newMonthsStatsTable = new RenderTable(newData.calculateMonthsStat, "monthsStat");
    }

     const ShowData = function (data) {
      this.sortIcon = (element) => {
        if (element === "Month") {
          upDate.calculateMonthsStat.sort((a, b) => {
          var dateA = new Date (`${a[element].split(".")[1]}-${a[element].split(".")[0]}`);
          var dateB = new Date (`${b[element].split(".")[1]}-${b[element].split(".")[0]}`);
          return  (i % 2 === 0) ? dateA - dateB : dateB - dateA
        })
        } else {
          upDate.calculateMonthsStat.sort((a, b) => {
            return (i % 2 === 0) ? a[element] - b[element] : b[element] - a[element];
            })
        }
      }

      this.sortTable = (parentElementId, element) => {
        ++i;
        (parentElementId === `${element}monthsStat`) ? this.sortIcon(element) : "";
        const sort = new RenderTable (upDate.calculateMonthsStat, "monthsStat");
        if (i % 2 === 0) {
        var tableBody = document.querySelector(`#${parentElementId}`);
        tableBody.style.transform = `rotate(360deg)`;
        tableBody.style.color = 'black';
        } else {
          var tableBody = document.querySelector(`#${parentElementId}`);
          tableBody.style.transform = `rotate(180deg)`;
          tableBody.style.color = 'black';
        }
      }

      const renderModalWindow = () => {
        var tableBody = document.querySelector("#modalWindow");
        const key = Object.keys(data[0]);
        tableBody.innerHTML = `${key.map(row => `<div>
                  <span class="input-group-text">${row}</span>
                  <${(row === "Date") ? `input type="date"` : `input type="text"`} class="form-control" aria-label="Dollar amount (with dot and two decimal places)" id="${row}">
                </div>`)}`;
      }

      this.addStatByDay = () => {
        const startSTat = Object.keys(data[0]).reduce((accum, icon) => {
        (icon === "Date") ? accum[icon] = document.getElementById(icon).value : accum[icon] = parseInt(document.getElementById(icon).value);
          return accum
        }, {})
        const statByDay = {...startSTat};
        const getData = data.map(date => date["Date"]);
        const auditData = getData.find(function(e){return e == statByDay["Date"]});
        auditData === statByDay["Date"] ? console.log("eror") : data.push(statByDay);
        window.localStorage.setItem("statByDay", JSON.stringify(data));
        renderBody();
      }
    renderModalWindow(data);
    }


    const upDate = new UpDate(staticByDay);
    const monthsStatsTable = new RenderTable(upDate.calculateMonthsStat, "monthsStat");
    const totalStatsTable = new RenderTable(upDate.calculateTotalStat, "totalStat");
    const show = new ShowData(upDate.data);
    </script>
  </body>
</html>