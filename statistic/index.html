<html>
  <head>
    <title>statistic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css" />
    <!-- TODO remove this after the data is properly handled -->
    <script type="text/javascript" src="data.js"></script>
  </head>
  <body>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_statistic">
      ADD Statistic
    </button>
    <div id="totalStat" class="table"></div>
    <div id="monthsStat" class="table"></div>
    <div class="modal fade" id="modal_statistic" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add statistic</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body ">
            <div class="input-group mb-3 statistic" id="modalWindow">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="newData.addStatByDay()">Add Statistic</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.8/ejs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script type="text/javascript" src="script.js"></script>
    <script type="text/javascript">


    const Table = function(data, parentElementId) {
      this.data = data;
      this.parentElementId = parentElementId;

      const nameRemder = () => {
        const name = document.querySelector(`#${this.parentElementId}`);
        name.innerHTML =
        `<table class="table table-striped">
            <thead>
              <tr>
                ${Object.keys(data[0]).map((key) => `<th scope="col"><button id="${key}">${key}&uarr;</button></th>`).join("")}
              </tr>
            </thead>
            <tbody>
            </tbody>
        </table>`
        }

        const buttonGroup = document.getElementById(parentElementId);
        let audit = false;
        const sortTable = (e) => {
          console.log(e.target.id)
          if (e.target.id === "Month") {
            data.sort((a, b) => {
              var dateA = new Date (`${a[e.target.id].split(".")[1]}-${a[e.target.id].split(".")[0]}`);
              var dateB = new Date (`${b[e.target.id].split(".")[1]}-${b[e.target.id].split(".")[0]}`);
            return  (audit === false) ? dateA - dateB : dateB - dateA
        })
        } else {
            data.sort((a, b) => {
            return (audit === false) ? a[e.target.id] - b[e.target.id] : b[e.target.id] - a[e.target.id];
            })
         }
         if (audit === true && e.target.id) {
           e.target.innerHTML = `${e.target.id}&darr;`;
        } else if (e.target.id){
           e.target.innerHTML = `${e.target.id}&uarr;`;
        }
        audit === true ? audit = false : audit = true;
         valueRender(data, parentElementId);
        }

        buttonGroup.addEventListener('click', sortTable);

      const valueRender = (data, parentElementId) => {
        var tableBody = document.querySelector(`#${this.parentElementId} >table tbody`);
        tableBody.innerHTML = data.map(column => `<tr>${Object.values(column).map(row => `<td>${row}</td>`).join("")}</tr>`).join("");
      }
      nameRemder();
      valueRender(data, parentElementId);
    }

      const RenderModalWindow = function() {
        const modal = () => {
          var tableBody = document.querySelector("#modalWindow");
          tableBody.innerHTML = `${Object.keys(staticByDay[0]).map(row => `<div>
                  <span class="input-group-text">${row}</span>
                  <${(row === "Date") ? `input type="date"` : `input type="text"`} class="form-control" id="${row}">
                </div>`)}`;
        }

         this.addStatByDay = () => {
          const startSTat = Object.keys(staticByDay[0]).reduce((accum, icon) => {
          (icon === "Date") ? accum[icon] = document.getElementById(icon).value : accum[icon] = parseInt(document.getElementById(icon).value);
            return accum
          }, {})
          dataModule.addStatByDay(startSTat);
          const monthsStatsTable = new Table(dataModule.calculateMonthsStat(), "monthsStat");
          const totalStatsTable = new Table(dataModule.calculateTotalStat(), "totalStat");
         }
        modal();
      }

    const newData = new RenderModalWindow();

    const monthsStatsTable = new Table(dataModule.calculateMonthsStat(), "monthsStat");
    const totalStatsTable = new Table(dataModule.calculateTotalStat(), "totalStat");
    </script>
  </body>
</html>